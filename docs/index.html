<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2018-08-25 Sat 22:19 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zetteldeft</title>
<meta name="generator" content="Org mode">
<meta name="author" content="EFLS">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel='stylesheet' href='style.css' type='text/css'/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Zetteldeft</h1>
</header>
<p>
This document contains all the source code to a set of functions for <code>emacs</code> which aim to extend the <code>deft</code> package and turn it into a (very very) basic Zettelkasten note-taking system.
</p>

<p>
Check out the github <a href="https://github.com/EFLS/zetteldeft">repository</a> to get the source.
Read on for an introduction and some documentation.
</p>

<p>
Latest additions:
</p>
<ul class="org-ul">
<li><b>25 Aug</b>: Renaming a file with <code>zd-file-rename</code> now also updates filename within the org-file. Also altered <code>zd-after-title</code>.</li>
<li><b>18 July</b>: Include a list of links with <code>zd-insert-list-links</code>, or a list of files with <code>zd-org-include-search</code>.</li>
<li><b>17 July</b>: Insert note title with <code>zd-insert-org-title</code>.</li>
<li><b>16 July</b>: Highlight zetteldeft links in <code>org-mode</code>.</li>
</ul>


<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge7f90fc">1. What?</a>
<ul>
<li><a href="#org3c1e7f0">1.1. A Zettelkasten system for <code>emacs</code> based on <code>deft</code></a></li>
<li><a href="#orge312532">1.2. Basic concepts</a></li>
<li><a href="#org34056a1">1.3. Basic functions</a></li>
<li><a href="#org7201471">1.4. How to use this source</a></li>
</ul>
</li>
<li><a href="#org733a065">2. <code>deft</code> setup</a>
<ul>
<li><a href="#orgfc18c13">2.1. Notes &amp; extensions</a></li>
<li><a href="#orgd9bae6d">2.2. Ignore more <code>org-mode</code> metadata</a></li>
</ul>
</li>
<li><a href="#org0b59013">3. <code>zetteldeft</code> functions</a>
<ul>
<li><a href="#org680aed9">3.1. Search functions</a></li>
<li><a href="#org9ed014c">3.2. IDs</a></li>
<li><a href="#orgc38eac6">3.3. Finding &amp; linking files from minibuffer</a></li>
<li><a href="#orgb72a753">3.4. New file creation</a></li>
<li><a href="#org9e1c0b1">3.5. Functions with <code>avy</code></a></li>
<li><a href="#orgdfa4f7d">3.6. Utility functions</a></li>
</ul>
</li>
<li><a href="#orgc68e6b3">4. Gathering notes</a>
<ul>
<li><a href="#orgece8e90">4.1. Idea</a></li>
<li><a href="#org4ef7c4f">4.2. Helper functions</a></li>
<li><a href="#org16e0ee9">4.3. List of links</a></li>
<li><a href="#org2670ea0">4.4. Compiling a single <code>org</code></a></li>
</ul>
</li>
<li><a href="#org1973f22">5. Aesthetics</a>
<ul>
<li><a href="#org10e55c1">5.1. Highlighting zetteldeft links</a></li>
</ul>
</li>
<li><a href="#org7411560">6. Brainstorm</a>
<ul>
<li><a href="#orge6b5be5">6.1. Saved searches</a></li>
<li><a href="#org6b6c635">6.2. Generate list of tags</a></li>
<li><a href="#orgd0b5cbf">6.3. HTML export</a></li>
<li><a href="#org6d3f49c">6.4. Markdown export</a></li>
<li><a href="#org0019ab4">6.5. Templates</a></li>
<li><a href="#orga2821ce">6.6. Minor mode</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-orge7f90fc" class="outline-2">
<h2 id="orge7f90fc"><span class="section-number-2">1</span> What?</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3c1e7f0" class="outline-3">
<h3 id="org3c1e7f0"><span class="section-number-3">1.1</span> A Zettelkasten system for <code>emacs</code> based on <code>deft</code></h3>
<div class="outline-text-3" id="text-1-1">
<p>
This is my feeble attempt at recreating a Zettelkasten environment by extending the excellent <code>deft</code> package in <code>emacs</code>.<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
I call it <b>zetteldeft</b>.
It is inspired by the <i>The Archive</i> app. For this and more on the Zettelkasten way of taking notes, see <a href="https://zettelkasten.de">zettelkasten.de</a>. They have a forum for discussion on both software and the specifics of the Zettelkasten philosophy.
</p>

<p>
The code that follows is created and maintained for my personal use, shared here in hope that it can benefit others as well.
I'd be happy to learn how you use it and expand upon it.
</p>

<p>
It is very much WIP and I'm fairly new to <code>elisp</code>, so it might contain some stupid code.
</p>

<p>
Anyway, here we go.
</p>
</div>
</div>

<div id="outline-container-orge312532" class="outline-3">
<h3 id="orge312532"><span class="section-number-3">1.2</span> Basic concepts</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<b>Notes</b> reside in the <code>deft-directory</code>.
Notes are written in <code>org-mode</code> (although this can be changed easily).
</p>

<p>
The filename of a note starts with a unique <b>id</b> based on the time and the date, for example: <code>2018-07-09-2115 This is a note.org</code>.
</p>

<p>
This unique id can be used to <b>link</b> notes together.
A link is indicated by a <code>§</code> character, followed by the id.
For example: <code>§2018-07-08-2115</code> should link to the file above.
A link can appear anywhere in the text.
</p>

<p>
When searching <code>deft</code> with the <b>id</b> as a filter, you'll find both the original note (with the id in its name) and all the notes that link to this note (with the id in its body). Do so with <code>zd-search-current-id</code> and <code>zd-avy-link-search</code> respectively
</p>

<p>
Notes can contain <b>tags</b>, prepended with a <code>#</code>.
This is a tag: <code>#tag</code>.
Tags make it easy to retrieve notes. They can appear anywhere in the note, but I'd suggest putting them somewhere at the top.
</p>

<p>
Call up a <code>deft</code> search on both tags and links with <code>zd-search-at-point</code>.
To jump to a tag or link and search it, use <code>zd-avy-tag-search</code> and <code>zd-avy-link-search</code> respectively.
To open a note from a link, use <code>zd-avy-file-search</code>.
</p>
</div>
</div>

<div id="outline-container-org34056a1" class="outline-3">
<h3 id="org34056a1"><span class="section-number-3">1.3</span> Basic functions</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Some functions to get started.
I created more, but these should be enough to get you started.
Default keybindings are set at the bottom &#x2013; and meant for spacemacs.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Function</th>
<th scope="col" class="org-left">Use</th>
<th scope="col" class="org-left">Keybinding</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>zd-search-at-point</code></td>
<td class="org-left">Search for thing at point</td>
<td class="org-left"><code>SPC d s</code></td>
</tr>

<tr>
<td class="org-left"><code>zd-search-current-id</code></td>
<td class="org-left">Search for id of current file</td>
<td class="org-left"><code>SPC d c</code></td>
</tr>

<tr>
<td class="org-left"><code>zd-avy-file-search</code></td>
<td class="org-left">Select <code>§</code> id and open linked file</td>
<td class="org-left"><code>SPC d f</code></td>
</tr>

<tr>
<td class="org-left"><code>zd-avy-link-search</code></td>
<td class="org-left">Select <code>§</code> id and search for it</td>
<td class="org-left"><code>SPC d l</code></td>
</tr>

<tr>
<td class="org-left"><code>zd-avy-tag-search</code></td>
<td class="org-left">Select <code>#</code> tag and search for it</td>
<td class="org-left"><code>SPC d t</code></td>
</tr>

<tr>
<td class="org-left"><code>zd-new-file</code></td>
<td class="org-left">Create new note and open</td>
<td class="org-left"><code>SPC d n</code></td>
</tr>

<tr>
<td class="org-left"><code>zd-new-file-and-link</code></td>
<td class="org-left">Create new note and insert <code>§</code> id</td>
<td class="org-left"><code>SPC d N</code></td>
</tr>

<tr>
<td class="org-left"><code>zd-find-file-id-insert</code></td>
<td class="org-left">Pick a note and insert its <code>§</code> id</td>
<td class="org-left"><code>SPC d i</code></td>
</tr>
</tbody>
</table>

<p>
More details documented below.
</p>
</div>
</div>

<div id="outline-container-org7201471" class="outline-3">
<h3 id="org7201471"><span class="section-number-3">1.4</span> How to use this source</h3>
<div class="outline-text-3" id="text-1-4">
<p>
This set of commands requires:
</p>
<ul class="org-ul">
<li><code>deft</code>, obviously</li>
<li><code>avy</code> comes in handy to jump &amp; search (see the final set of functions)</li>
</ul>

<p>
From the github repository, either
</p>
<ul class="org-ul">
<li>download the <code>org-file</code> and <code>org-tangle</code> it yourself. It should contain everything.</li>
<li>or download the <code>zetteldeft.el</code> file.</li>
</ul>

<p>
Whichever way you go, load the <code>.el</code> file in emacs with
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(load <span style="color: #4F894C;">"/path/to/zetteldeft.el"</span>)
</pre>
</div>

<p>
and you're good to go!
</p>
</div>
</div>
</div>

<div id="outline-container-org733a065" class="outline-2">
<h2 id="org733a065"><span class="section-number-2">2</span> <code>deft</code> setup</h2>
<div class="outline-text-2" id="text-2">
<p>
The following assumes <code>deft</code> is loaded manually in your dotfile, it merely configures the package.
</p>
</div>

<div id="outline-container-orgfc18c13" class="outline-3">
<h3 id="orgfc18c13"><span class="section-number-3">2.1</span> Notes &amp; extensions</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Note extensions are <code>md</code>, <code>txt</code> and <code>org</code>.
First of this list is the default for new notes.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">setq</span> deft-extensions '(<span style="color: #4F894C;">"org"</span> <span style="color: #4F894C;">"md"</span> <span style="color: #4F894C;">"txt"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd9bae6d" class="outline-3">
<h3 id="orgd9bae6d"><span class="section-number-3">2.2</span> Ignore more <code>org-mode</code> metadata</h3>
<div class="outline-text-3" id="text-2-2">
<p>
I tend to write <code>org-mode</code> titles with <code>#+title:</code> (i.e., uncapitalized). Also other <code>org-mode</code> code at the beginning is written in lower case.
</p>

<p>
In order to filter these from the deft summary, let's alter the regular expression:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">setq</span> deft-strip-summary-regexp
 (concat <span style="color: #4F894C;">"</span><span style="color: #3B6EA8; font-weight: bold;">\\</span><span style="color: #3B6EA8; font-weight: bold;">(</span><span style="color: #4F894C;">"</span>
         <span style="color: #4F894C;">"[\n\t]"</span> <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">blank</span>
         <span style="color: #4F894C;">"</span><span style="color: #3B6EA8; font-weight: bold;">\\</span><span style="color: #3B6EA8; font-weight: bold;">|</span><span style="color: #4F894C;">^#\\+[a-zA-Z_]+:.*$"</span> <span style="color: #8b94a5;">;;</span><span style="color: #8b94a5;">org-mode metadata</span>
         <span style="color: #4F894C;">"</span><span style="color: #3B6EA8; font-weight: bold;">\\</span><span style="color: #3B6EA8; font-weight: bold;">)</span><span style="color: #4F894C;">"</span>))
</pre>
</div>

<p>
Its original value was <code>\\([\n ]\\|^#\\+[[:upper:]_]+:.*$\\)</code>.
</p>
</div>
</div>
</div>


<div id="outline-container-org0b59013" class="outline-2">
<h2 id="org0b59013"><span class="section-number-2">3</span> <code>zetteldeft</code> functions</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org680aed9" class="outline-3">
<h3 id="org680aed9"><span class="section-number-3">3.1</span> Search functions</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-org4bc94e2" class="outline-4">
<h4 id="org4bc94e2"><span class="section-number-4">3.1.1</span> <code>zd-get-thing-at-point</code> returns string</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Returns the thing at point as string.
</p>

<p>
Tries to get, in the following order:
</p>
<ul class="org-ul">
<li>links between <code>[[</code></li>
<li>hashtags: <code>§</code>, <code>#</code> or <code>@</code></li>
<li>words</li>
</ul>

<p>
Based on snippet suggested by <code>saf-dmitry</code> on deft's <a href="https://github.com/jrblevin/deft/issues/52#issuecomment-401766828">Github</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-get-thing-at-point</span> ()
<span style="color: #828b9b;">"Return the thing at point, which can be a link, tag or word."</span>
  (<span style="color: #3B6EA8;">require</span> '<span style="color: #97365B;">thingatpt</span>)
  (<span style="color: #3B6EA8;">let*</span> ((link-re <span style="color: #4F894C;">"\\[\\[</span><span style="color: #3B6EA8; font-weight: bold;">\\</span><span style="color: #3B6EA8; font-weight: bold;">(</span><span style="color: #4F894C;">[</span><span style="color: #3B6EA8; font-weight: bold;">^</span><span style="color: #4F894C;">]]+</span><span style="color: #3B6EA8; font-weight: bold;">\\</span><span style="color: #3B6EA8; font-weight: bold;">)</span><span style="color: #4F894C;">\\]\\]"</span>)
         (htag-re <span style="color: #4F894C;">"</span><span style="color: #3B6EA8; font-weight: bold;">\\</span><span style="color: #3B6EA8; font-weight: bold;">(</span><span style="color: #4F894C;">[&#167;#@][[:alnum:]_-]+</span><span style="color: #3B6EA8; font-weight: bold;">\\</span><span style="color: #3B6EA8; font-weight: bold;">)</span><span style="color: #4F894C;">"</span>))
   (<span style="color: #3B6EA8;">cond</span>
    ((thing-at-point-looking-at link-re)
      (match-string-no-properties 1))
     ((thing-at-point-looking-at htag-re)
      (match-string-no-properties 1))
     (t (thing-at-point 'word t)))
  ))
</pre>
</div>
</div>
</div>

<div id="outline-container-org18e482f" class="outline-4">
<h4 id="org18e482f"><span class="section-number-4">3.1.2</span> <code>zd-search-at-point</code> thing at point</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
Search the thing at point.
Note that calling <code>zd-search-at-point</code> on a <code>§</code> link includes <code>§</code> in the filter string.
</p>


<p>
Based on snippet suggested by <code>saf-dmitry</code> on deft's <a href="https://github.com/jrblevin/deft/issues/52#issuecomment-401766828">Github</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-search-at-point</span> ()
<span style="color: #828b9b;">"Search deft with thing-at-point as filter.</span>
<span style="color: #828b9b;">Thing can be a double-bracketed link, a hashtag, or a word."</span>
  (<span style="color: #3B6EA8;">interactive</span>)
  (<span style="color: #3B6EA8;">let</span> ((string (zd-get-thing-at-point)))
   (<span style="color: #3B6EA8;">if</span> string
       (zd-search-global string t)
     (<span style="color: #9A7500;">user-error</span> <span style="color: #4F894C;">"No search term at point"</span>)))
  )
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbf98808" class="outline-4">
<h4 id="orgbf98808"><span class="section-number-4">3.1.3</span> <code>zd-search-global</code> for string</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
Search with deft for given string.
If there is only one result, that file is opened, unless additional argument is true.
</p>

<p>
Based on snippet suggested by <code>saf-dmitry</code> on deft's <a href="https://github.com/jrblevin/deft/issues/52#issuecomment-401766828">Github</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-search-global</span> (str <span style="color: #9A7500;">&amp;optional</span> dntOpn)
<span style="color: #828b9b;">"Search deft with STR as filter.</span>
<span style="color: #828b9b;">If there is only one result, open that file (unless DNTOPN is true)."</span>
  <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">Sanitize the filter string</span>
  (<span style="color: #3B6EA8;">setq</span> str (replace-regexp-in-string <span style="color: #4F894C;">"[[:space:]\n]+"</span> <span style="color: #4F894C;">" "</span> str))
  <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">Call deft search on the filter string</span>
  (<span style="color: #3B6EA8;">let</span> ((deft-incremental-search t))
   (deft)
   (deft-filter str t))
  <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">If there is a single match, open the file</span>
  (<span style="color: #3B6EA8;">unless</span> dntOpn
   (<span style="color: #3B6EA8;">when</span> (eq (length deft-current-files) 1)
     (deft-open-file (car deft-current-files)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org84d4b50" class="outline-4">
<h4 id="org84d4b50"><span class="section-number-4">3.1.4</span> <code>zd-search-filename</code> for string</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
Deft search on filename.
If there is only one result, open that file.
</p>

<p>
Incremental search is turned off, and the filter is set to filenames only.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-search-filename</span> (str)
<span style="color: #828b9b;">"Search for deft files with string STR in filename.</span>
<span style="color: #828b9b;">Open if there is only one result."</span>
  <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">Sanitize the filter string</span>
  (<span style="color: #3B6EA8;">setq</span> str (replace-regexp-in-string <span style="color: #4F894C;">"[[:space:]\n]+"</span> <span style="color: #4F894C;">" "</span> str))
  <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">Call deft search on the filter string</span>
  (<span style="color: #3B6EA8;">let</span> ((deft-filter-only-filenames t))
   (deft)
   (deft-filter str t))
  <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">If there is a single match, open the file</span>
  (<span style="color: #3B6EA8;">when</span> (eq (length deft-current-files) 1)
    (deft-open-file (car deft-current-files))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0ca953c" class="outline-4">
<h4 id="org0ca953c"><span class="section-number-4">3.1.5</span> <code>zd-search-current-id</code> searches current id</h4>
<div class="outline-text-4" id="text-3-1-5">
<p>
Deft search on the id of the current file.
</p>

<p>
Result is not opened automaticaly.
</p>

<p>
This function is useful to easily see which notes link to the current file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-search-current-id</span> ()
<span style="color: #828b9b;">"Search deft with the id of the current file as filter.</span>
<span style="color: #828b9b;">Open if there is only one result."</span>
 (<span style="color: #3B6EA8;">interactive</span>)
 (zd-search-global (zd-id-current-file) t)
)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9ed014c" class="outline-3">
<h3 id="org9ed014c"><span class="section-number-3">3.2</span> IDs</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org6ad6539" class="outline-4">
<h4 id="org6ad6539"><span class="section-number-4">3.2.1</span> Basics for IDs</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
String format when generating ids.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defcustom</span> <span style="color: #842879;">zd-id-format</span> <span style="color: #4F894C;">"%Y-%m-%d-%H%M"</span>
  <span style="color: #828b9b;">"Format used when generating zetteldeft IDs."</span>
  <span style="color: #29838D;">:type</span> 'string
  <span style="color: #29838D;">:group</span> 'zetteldeft
)
</pre>
</div>

<p>
While we're at it, lets tell deft to create new files with this new format.
For good measure: I'd advise creating new notes in the <code>zetteldeft</code> system with <code>zd-new-file</code> or <code>zd-new-file-and-link</code>. See below.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">setq</span> deft-new-file-format zd-id-format)
</pre>
</div>

<p>
Here is a function to generate an id string in said format.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-generate-id</span> ()
 <span style="color: #828b9b;">"Generates an id in `</span><span style="color: #97365B;">zd-id-format</span><span style="color: #828b9b;">'."</span>
 (format-time-string zd-id-format)
)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9fa2664" class="outline-4">
<h4 id="org9fa2664"><span class="section-number-4">3.2.2</span> <code>zd-id-insert</code> inserts id</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
A helper function to insert a generated id.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-id-insert</span> ()
 (<span style="color: #3B6EA8;">interactive</span>)
 <span style="color: #4F894C;">"Inserts an id in `</span><span style="color: #97365B;">zd-id-format</span><span style="color: #4F894C;">'."</span>
 (insert (zd-generate-id) <span style="color: #4F894C;">" "</span>)
)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgef642f2" class="outline-4">
<h4 id="orgef642f2"><span class="section-number-4">3.2.3</span> <code>zd-id-sanitized</code> cleans ids</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
Returns the string stripped from everything that is not a number or a <code>-</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-id-sanitized</span> (str)
<span style="color: #828b9b;">"Strip STRING from everything that is not a number or a dash."</span>
 (replace-regexp-in-string <span style="color: #4F894C;">"[</span><span style="color: #3B6EA8; font-weight: bold;">^</span><span style="color: #4F894C;">(0-9)-]+"</span> <span style="color: #4F894C;">""</span> str)
)
</pre>
</div>

<p>
Potential shortcomming: any numbers <i>after</i> the id are not stripped.
Problematic when stripping the id from a filename, for example.
</p>

<p>
The following regular expression should work better: <code>[0-9-]\\{2,\\}-[0-9-]+</code> (but cannot be used with <code>replace-regexp-in-string</code> function). Something to fix.
</p>
</div>
</div>

<div id="outline-container-orge4ad71b" class="outline-4">
<h4 id="orge4ad71b"><span class="section-number-4">3.2.4</span> <code>zd-file-id-stripped</code> strips file id from string</h4>
<div class="outline-text-4" id="text-3-2-4">
<p>
Attempts to strip the file id from a string.
</p>

<p>
This requires a <b>fix</b>, or better yet, a reimplementation. Too crude at the moment.
</p>

<p>
First, take only 17 first characters from the input string.
Next, omit anything that is not a digit or a dash.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-file-id-stripped</span> (file)
<span style="color: #828b9b;">"Returns file id stripped from given filename FILE."</span>
 (<span style="color: #3B6EA8;">let</span> ((file (substring file 0 16)))
   (zd-id-sanitized file)
))
</pre>
</div>
</div>
</div>


<div id="outline-container-org72399a4" class="outline-4">
<h4 id="org72399a4"><span class="section-number-4">3.2.5</span> <code>zd-id-current-file</code> returns id in filename</h4>
<div class="outline-text-4" id="text-3-2-5">
<p>
Return the id from the filename the buffer is currently visiting.
</p>

<p>
Requires <b>fix</b>: filenames with numbers in it are not fully stripped.
</p>

<p>
Steps:
</p>
<ol class="org-ol">
<li>Get the filename from the buffer</li>
<li>Strip the ID from it.</li>
<li>Result can be empty string when no id is detected in the filename.</li>
</ol>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-id-current-file</span> ()
<span style="color: #828b9b;">"Return the id from the filename the buffer is currently visiting."</span>
 (zd-file-id-stripped (file-name-base (buffer-file-name)))
)
</pre>
</div>
</div>
</div>

<div id="outline-container-org1c79604" class="outline-4">
<h4 id="org1c79604"><span class="section-number-4">3.2.6</span> <code>zd-copy-id-current-file</code> copies id in filename</h4>
<div class="outline-text-4" id="text-3-2-6">
<p>
Add the ID from the current file to the kill ring.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-copy-id-current-file</span> ()
<span style="color: #828b9b;">"Add the id from the filename the buffer is currently visiting to the kill ring."</span>
(<span style="color: #3B6EA8;">interactive</span>)
 (kill-new (zd-id-current-file))
)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc38eac6" class="outline-3">
<h3 id="orgc38eac6"><span class="section-number-3">3.3</span> Finding &amp; linking files from minibuffer</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-org53691ec" class="outline-4">
<h4 id="org53691ec"><span class="section-number-4">3.3.1</span> <code>zd-find-file</code> opens file from minibuffer</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
Select file from the deft folder from the minibuffer.
</p>

<p>
Based on <code>deft-find-file</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-find-file</span> (file)
<span style="color: #828b9b;">"Open deft file FILE."</span>
 (<span style="color: #3B6EA8;">interactive</span>
  (list (completing-read <span style="color: #4F894C;">"Deft find file: "</span>
        (deft-find-all-files-no-prefix))))
 (deft-find-file file)
)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd374092" class="outline-4">
<h4 id="orgd374092"><span class="section-number-4">3.3.2</span> <code>zd-find-file-id-copy</code> copies file id</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
Select file from minibuffer and add its link id to kill ring.
</p>

<p>
Based on <code>deft-find-file</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-find-file-id-copy</span> (file)
<span style="color: #828b9b;">"Find deft file FILE and add its id to the kill ring."</span>
 (<span style="color: #3B6EA8;">interactive</span> (list
        (completing-read <span style="color: #4F894C;">"File to copy id from: "</span>
        (deft-find-all-files-no-prefix))))
  (kill-new (concat <span style="color: #4F894C;">"&#167;"</span> (zd-file-id-stripped file)))
)
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a7b702" class="outline-4">
<h4 id="org0a7b702"><span class="section-number-4">3.3.3</span> <code>zd-find-file-id-insert</code> inserts file id</h4>
<div class="outline-text-4" id="text-3-3-3">
<p>
Select file from minibuffer and insert its link, prepended by <code>§</code>.
</p>

<p>
Based on <code>deft-find-file</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-find-file-id-insert</span> (file)
<span style="color: #828b9b;">"Find deft file FILE and insert its link id, prepended by &#167;."</span>
 (<span style="color: #3B6EA8;">interactive</span> (list
        (completing-read <span style="color: #4F894C;">"File to insert id from: "</span>
        (deft-find-all-files-no-prefix))))
  (insert (concat <span style="color: #4F894C;">"&#167;"</span> (zd-file-id-stripped file)))
)
</pre>
</div>
</div>
</div>

<div id="outline-container-org1260342" class="outline-4">
<h4 id="org1260342"><span class="section-number-4">3.3.4</span> <code>zd-find-file-full-title-insert</code> inserts full file title</h4>
<div class="outline-text-4" id="text-3-3-4">
<p>
Select file from minibuffer and insert its link, prepended by <code>§</code>.
</p>

<p>
Based on <code>deft-find-file</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-find-file-full-title-insert</span> (file)
<span style="color: #828b9b;">"Find deft file FILE and insert its link id with title, prepended by &#167;."</span>
 (<span style="color: #3B6EA8;">interactive</span> (list
        (completing-read <span style="color: #4F894C;">"File to insert full title from: "</span>
        (deft-find-all-files-no-prefix))))
  (insert (concat <span style="color: #4F894C;">"&#167;"</span> (file-name-base file)))
)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb72a753" class="outline-3">
<h3 id="orgb72a753"><span class="section-number-3">3.4</span> New file creation</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-org581c6e1" class="outline-4">
<h4 id="org581c6e1"><span class="section-number-4">3.4.1</span> <code>zd-new-file</code> creates new file</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
Create new file with filename as <code>zd-id-format</code> and a string.
</p>

<p>
Either provide a name as argument, or enter one in the mini-buffer.
A title is automatically added to the file, unless an additioanl parameter is given.
When <code>evil</code> is used, enter the insert state as well.
The full name is added to the kill ring.
Note that the file is only actually created upon save.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-new-file</span> (str <span style="color: #9A7500;">&amp;optional</span> empty)
<span style="color: #828b9b;">"Create a new deft file. Filename is `</span><span style="color: #97365B;">zd-id-format</span><span style="color: #828b9b;">' appended by STR. No extension needed.</span>

<span style="color: #828b9b;">After creating, the title is inserted in org-mode format (unless EMPTY is true) and the full file name is added to the kill ring."</span>
 (<span style="color: #3B6EA8;">interactive</span> (list (read-string <span style="color: #4F894C;">"name: "</span>)))
 (<span style="color: #3B6EA8;">let*</span> ((zdId (zd-generate-id))
        (zdName (concat zdId <span style="color: #4F894C;">" "</span> str)))
 (deft-new-file-named zdName)
 (kill-new zdName)
 (<span style="color: #3B6EA8;">unless</span> empty (zd-insert-org-title))
 (<span style="color: #3B6EA8;">when</span> (<span style="color: #3B6EA8;">featurep</span> '<span style="color: #97365B;">evil</span>) (evil-insert-state))
))
</pre>
</div>
</div>
</div>

<div id="outline-container-org66d433a" class="outline-4">
<h4 id="org66d433a"><span class="section-number-4">3.4.2</span> <code>zd-new-file-and-link</code> inserts generated id</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
Generate an id, append a name, and generate a new file based on id and link.
</p>

<p>
Either provide a name as argument, or enter one in the mini-buffer.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-new-file-and-link</span> (str)
<span style="color: #828b9b;">"Inserts generated id with `</span><span style="color: #97365B;">zd-id-format</span><span style="color: #828b9b;">' appended with STR.</span>
<span style="color: #828b9b;">Creates new deft file with id and STR as name."</span>
 (<span style="color: #3B6EA8;">interactive</span> (list (read-string <span style="color: #4F894C;">"name: "</span>)))
 (insert <span style="color: #4F894C;">"&#167;"</span> (zd-generate-id) <span style="color: #4F894C;">" "</span> str)
 (zd-new-file str)
)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9e1c0b1" class="outline-3">
<h3 id="org9e1c0b1"><span class="section-number-3">3.5</span> Functions with <code>avy</code></h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-orga1516ea" class="outline-4">
<h4 id="orga1516ea"><span class="section-number-4">3.5.1</span> <code>zd-avy-tag-search</code></h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
Use avy to jump to a tag and search for it.
</p>

<p>
The search term should include the <code>#</code> as tag identifier, so it's as easy as jumping to the <code>#</code> and running <code>zd-search-at-point</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-avy-tag-search</span> ()
<span style="color: #828b9b;">"Call on avy to jump and search tags indicated with #."</span>
 (<span style="color: #3B6EA8;">interactive</span>)
 (<span style="color: #3B6EA8;">save-excursion</span>
  (avy-goto-char ?#)
  (zd-search-at-point)
))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb42db80" class="outline-4">
<h4 id="orgb42db80"><span class="section-number-4">3.5.2</span> <code>zd-avy-link-search</code></h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
Use avy to jump to an id and search for it.
</p>

<p>
Jumps to the <code>§</code> identifier and searches for the thing at point &#x2013; excluding the <code>§</code> character.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-avy-link-search</span> ()
<span style="color: #828b9b;">"Call on avy to jump and search link ids indicated with &#167;.</span>
<span style="color: #828b9b;">Opens immediately if there is only one result."</span>
 (<span style="color: #3B6EA8;">interactive</span>)
 (<span style="color: #3B6EA8;">save-excursion</span>
  (avy-goto-char ?&#167;)
  (zd-search-global (zd-id-sanitized (zd-get-thing-at-point)))
))
</pre>
</div>
</div>
</div>

<div id="outline-container-org07757b3" class="outline-4">
<h4 id="org07757b3"><span class="section-number-4">3.5.3</span> <code>zd-avy-file-search</code></h4>
<div class="outline-text-4" id="text-3-5-3">
<p>
Use avy to jump to an id and find the corresponding file.
There should be only one result, as the id should be unique.
</p>

<p>
Jump to a <code>§</code> with <code>avy</code>, get the thing at point.
If it is non-nil, search it after sanitizing.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-avy-file-search</span> ()
<span style="color: #828b9b;">"Call on avy to jump to link ids indicated with &#167; and use it to search for filenames."</span>
 (<span style="color: #3B6EA8;">interactive</span>)
 (<span style="color: #3B6EA8;">save-excursion</span>
  (avy-goto-char ?&#167;)
  (zd-search-filename (zd-id-sanitized (zd-get-thing-at-point)))
))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdfa4f7d" class="outline-3">
<h3 id="orgdfa4f7d"><span class="section-number-3">3.6</span> Utility functions</h3>
<div class="outline-text-3" id="text-3-6">
</div>
<div id="outline-container-orgc9d6321" class="outline-4">
<h4 id="orgc9d6321"><span class="section-number-4">3.6.1</span> Deft new search</h4>
<div class="outline-text-4" id="text-3-6-1">
<p>
The following function launches deft, clears the filter and enters <code>evil-insert-state</code> (when evil is used).
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-deft-new-search</span> ()
<span style="color: #828b9b;">"Launch deft, clear filter and enter insert state."</span>
 (<span style="color: #3B6EA8;">interactive</span>)
 (deft)
 (deft-filter-clear)
 (<span style="color: #3B6EA8;">when</span> (<span style="color: #3B6EA8;">featurep</span> '<span style="color: #97365B;">evil</span>) (evil-insert-state))
)
</pre>
</div>
</div>
</div>

<div id="outline-container-org46babf8" class="outline-4">
<h4 id="org46babf8"><span class="section-number-4">3.6.2</span> <code>zd-file-rename</code> renames visited file</h4>
<div class="outline-text-4" id="text-3-6-2">
<p>
Rename the current file.
Based on the function <code>deft-rename-file</code> with only minor changes in the way <code>old-filename</code> is set: from current buffer rather than from <code>deft</code> search buffer.
</p>

<p>
Probably requires some more testing.
Anyway, best to use this only when visiting a file in the deft directory.
</p>

<p>
The function also updates the <code>#+title:</code> at the top of the buffer, if any is present.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-file-rename</span> ()
<span style="color: #828b9b;">"Rename the current file via the deft function. Use this on files in the deft-directory."</span>
 (<span style="color: #3B6EA8;">interactive</span>)
  (<span style="color: #3B6EA8;">let</span> ((old-filename (buffer-file-name))
        (deft-dir (file-name-as-directory deft-directory))
        new-filename old-name new-name)
    (<span style="color: #3B6EA8;">when</span> old-filename
      (<span style="color: #3B6EA8;">setq</span> old-name (deft-base-filename old-filename))
      (<span style="color: #3B6EA8;">setq</span> new-name (read-string
                      (concat <span style="color: #4F894C;">"Rename "</span> old-name <span style="color: #4F894C;">" to (without extension): "</span>)
                      old-name))
      (<span style="color: #3B6EA8;">setq</span> new-filename
            (concat deft-dir new-name <span style="color: #4F894C;">"."</span> deft-default-extension))
      (rename-file old-filename new-filename)
      (deft-update-visiting-buffers old-filename new-filename)
      (zd-update-title-in-file)
      (deft-refresh))))
</pre>
</div>

<p>
To update the title of the currently visited file, the following function is used.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-update-title-in-file</span> ()
<span style="color: #828b9b;">"Update the #+TITLE in the current file, if present."</span>
  (<span style="color: #3B6EA8;">save-excursion</span>
    (<span style="color: #3B6EA8;">let</span> ((zd-string-after-title <span style="color: #4F894C;">""</span>))
      (goto-char (point-min))
      (<span style="color: #3B6EA8;">when</span> (search-forward <span style="color: #4F894C;">"#+title:"</span> nil t)
        (delete-region (line-beginning-position) (line-end-position))
        (zd-insert-org-title)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbfae4d9" class="outline-4">
<h4 id="orgbfae4d9"><span class="section-number-4">3.6.3</span> <code>zd-insert-org-title</code> inserts file title in org-mode</h4>
<div class="outline-text-4" id="text-3-6-3">
<p>
Easily insert the title of the current file in <code>org-mode</code> syntax, i.e. as a <code>#+title:</code> line.
</p>

<p>
The code gets the base of the buffer file name, takes from it the file title (i.e. strips the link id at the beginning), and inserts the remaining string.
</p>

<p>
Below the title, an additional template string is inserted automatically.
This string, variable <code>zd-string-after-title</code>, can be customized and is empty by default.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-insert-org-title</span> ()
 (<span style="color: #3B6EA8;">interactive</span>)
 (insert
   <span style="color: #4F894C;">"#+title: "</span>
   (zd-lift-file-title (file-name-base (buffer-file-name)))
   zd-string-after-title))
</pre>
</div>

<p>
Customize the string to be inserted below the title.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defcustom</span> <span style="color: #842879;">zd-string-after-title</span> <span style="color: #4F894C;">""</span>
  <span style="color: #828b9b;">"String inserted below title when `</span><span style="color: #97365B;">zd-insert-org-title</span><span style="color: #828b9b;">' is called.</span>
<span style="color: #828b9b;">Empty by default.</span>
<span style="color: #828b9b;">Don't forget to add `</span><span style="color: #97365B;">\\n</span><span style="color: #828b9b;">' at the beginning to start a new line."</span>
  <span style="color: #29838D;">:type</span> 'string
  <span style="color: #29838D;">:group</span> 'zetteldeft)
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc68e6b3" class="outline-2">
<h2 id="orgc68e6b3"><span class="section-number-2">4</span> Gathering notes</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgece8e90" class="outline-3">
<h3 id="orgece8e90"><span class="section-number-3">4.1</span> Idea</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Sometimes you want to easily gather all notes with a certain tag or search term.
Say you want to quickly generate a list of links to all files including the tag <code>#zetteldeft</code>.
</p>

<p>
The following functions automate that process:
</p>
<ul class="org-ul">
<li><code>zd-insert-list-links</code> promts for a search string and inserts a list of notes</li>
<li><code>zd-org-include-search</code> generates <code>#+INCLUDE</code> code for <code>org-mode</code> for these files.</li>
</ul>
</div>
</div>

<div id="outline-container-org4ef7c4f" class="outline-3">
<h3 id="org4ef7c4f"><span class="section-number-3">4.2</span> Helper functions</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-org1ca84d1" class="outline-4">
<h4 id="org1ca84d1"><span class="section-number-4">4.2.1</span> <code>zd-get-file-list</code> returns file list on search</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Get a list of the files with given search string.
</p>

<p>
To <b>fix</b>: sorting of results.
</p>

<p>
The code searches for the given string and returns <code>deft-current-files</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-get-file-list</span> (srch)
<span style="color: #828b9b;">"Returns a list of files with the search item SRCH."</span>
  (<span style="color: #3B6EA8;">let</span> ((deft-current-sort-method 'title))
   (deft-filter srch t)
   deft-current-files
))
</pre>
</div>
</div>
</div>


<div id="outline-container-org7790ed4" class="outline-4">
<h4 id="org7790ed4"><span class="section-number-4">4.2.2</span> <code>zd-lift-file-title</code> returns file title from path</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
Returns only the file title from a file, removing path, extension, and link ID.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-lift-file-title</span> (zdFile)
 (<span style="color: #3B6EA8;">let</span> ((baseName (file-name-base zdFile)))
   (replace-regexp-in-string
    <span style="color: #4F894C;">"[0-9]\\{2,\\}-[0-9-]+[[:space:]]"</span>
    <span style="color: #4F894C;">""</span> baseName)
))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org16e0ee9" class="outline-3">
<h3 id="org16e0ee9"><span class="section-number-3">4.3</span> List of links</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-org27cf0e5" class="outline-4">
<h4 id="org27cf0e5"><span class="section-number-4">4.3.1</span> <code>zd-insert-list-links</code> generates list with tagged files</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
Creates and inserts a list with links to all files with selected search term.
</p>

<p>
The code gets a list of files that contain the search string, runs through said list and inserts a link for each entry.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-insert-list-links</span> (zdSrch)
<span style="color: #828b9b;">"Inserts at point a list of links to all deft files with a search string ZDSRCH.</span>
<span style="color: #828b9b;">When searching for a tag, include # manually in the prompt."</span>
 (<span style="color: #3B6EA8;">interactive</span> (list (read-string <span style="color: #4F894C;">"search string: "</span>)))
 (<span style="color: #3B6EA8;">dolist</span> (zdFile (zd-get-file-list zdSrch))
  (zd-list-entry-file-link zdFile)
))
</pre>
</div>
</div>
</div>

<div id="outline-container-org72dceff" class="outline-4">
<h4 id="org72dceff"><span class="section-number-4">4.3.2</span> <code>zd-list-entry-file-link</code> includes a file link as list entry</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
Inserts for given file a link id and title as a list entry.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-list-entry-file-link</span> (zdFile)
<span style="color: #828b9b;">"Insert ZDFILE as list entry."</span>
 (insert <span style="color: #4F894C;">" - "</span> (concat <span style="color: #4F894C;">"&#167;"</span> (file-name-base zdFile)) <span style="color: #4F894C;">"\n"</span>)
)
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org2670ea0" class="outline-3">
<h3 id="org2670ea0"><span class="section-number-3">4.4</span> Compiling a single <code>org</code></h3>
<div class="outline-text-3" id="text-4-4">
</div>
<div id="outline-container-org50a073a" class="outline-4">
<h4 id="org50a073a"><span class="section-number-4">4.4.1</span> Idea and example</h4>
<div class="outline-text-4" id="text-4-4-1">
</div>
<div id="outline-container-orgcdeb0ee" class="outline-5">
<h5 id="orgcdeb0ee"><span class="section-number-5">4.4.1.1</span> Including notes with given tag</h5>
<div class="outline-text-5" id="text-4-4-1-1">
<p>
For each of the notes with the <code>#tag</code>, it inserts a heading, a line with <code>#+INCLUDE</code> and the full path to the relevant notes.
This results in a single file that can be easily exported.
</p>

<p>
The only function meant for use on the users end, is <code>zd-org-include-search</code>.
</p>

<p>
For example,
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(zd-org-include-files <span style="color: #4F894C;">"#export"</span>)
</pre>
</div>

<p>
inserts necessary code to include all files containing the tag <code>#export</code>.
The results could look like the following:
</p>

<div class="org-src-container">
<pre class="src src-org">\* First file title
<span style="color: #828b9b;">#+INCLUDE: "/path/to/2018-07-13-2210 First file title.org"</span>

\* File two
<span style="color: #828b9b;">#+INCLUDE: "/path/to/2018-07-13-2223 File two.org"</span>
</pre>
</div>

<p>
All functions are documented below.
</p>
</div>
</div>

<div id="outline-container-org47c0dae" class="outline-5">
<h5 id="org47c0dae"><span class="section-number-5">4.4.1.2</span> Semi-automated example</h5>
<div class="outline-text-5" id="text-4-4-1-2">
<p>
You could, for example, add the following code to a document and execute (or evaluate) it from within <code>org-mode</code>.
Add it under a "comment" type heading to prevent it from being exported itself, like so: <code>* COMMENT Code</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">let</span> (frst)
  (<span style="color: #3B6EA8;">save-excursion</span>
    <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">Move to next heading</span>
    (outline-next-heading)
    (<span style="color: #3B6EA8;">setq</span> frst (point))
    <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">Delete everything after</span>
    (delete-region frst (point-max))
    <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">Include the files</span>
    (zd-org-include-search <span style="color: #4F894C;">"#tag"</span>)
    <span style="color: #8b94a5;">; </span><span style="color: #8b94a5;">Sort these entries alphabetically (set mark to use a region)</span>
<span style="color: #8b94a5;">;   </span><span style="color: #8b94a5;">(goto-char frst) (set-mark (point-max))</span>
<span style="color: #8b94a5;">;   </span><span style="color: #8b94a5;">(org-sort-entries nil ?a)</span>
  ))
</pre>
</div>

<p>
The code deletes everything after the current header and inserts all notes with <code>#tag</code> in them.
</p>

<p>
In order to also sort the entries alphabetically, uncomment the last two lines.
</p>

<p>
Don't put the file with the above code in you <code>deft</code> folder, or it will attempt to include itself (since it has <code>#tag</code> in it).
</p>
</div>
</div>

<div id="outline-container-orgb28c576" class="outline-5">
<h5 id="orgb28c576"><span class="section-number-5">4.4.1.3</span> Issues &amp; things to note</h5>
<div class="outline-text-5" id="text-4-4-1-3">
<p>
Before we look at the functions, a note on limitations of the current implementation.
</p>

<ol class="org-ol">
<li><b>Over-enthousiastic inclusion</b>
Sometimes, a tag appears in a file without the need for it to be included.
For example, a file with a list of all tags will also include the tag one wants.
In the future, this might be resolved by filtering, for example with <a href="http://ergoemacs.org/emacs/elisp_filter_list.html">http://ergoemacs.org/emacs/elisp_filter_list.html</a>.</li>

<li><b>Inclusion from second line onwards</b>
Currently, the <code>#+INCLUDE</code> lines only include from the second line onwards.
This is a work-around to prevent <code>#+TITLE</code> lines from being included (and messing up the title on <code>org-export</code>.
To change this, edit the inserted strings in the <code>zd-org-include-file</code> function.</li>

<li><b>Sorting</b>
The files included are unsorted, or rather: sorted as <code>deft</code> provides the results.
Attempts at sorting by title are included in <code>zd-get-file-list</code>, but not working properly.
As a solution, use <code>org-sort</code> manually after running <code>zd-org-include-search</code>.</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org2afcb72" class="outline-4">
<h4 id="org2afcb72"><span class="section-number-4">4.4.2</span> <code>zd-org-include-search</code> generates <code>#+INCLUDE</code> code</h4>
<div class="outline-text-4" id="text-4-4-2">
<p>
Asks user for a search string and inserts headers and <code>#+INCLUDE</code> code for all files with said tag.
When used on <code>#tag</code>, make sure to include the <code>#</code> manually.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-org-include-search</span> (zdSrch)
<span style="color: #828b9b;">"Inserts at point org-mode code to include all files with the selected tag. Include the # manually in the prompt."</span>
 (<span style="color: #3B6EA8;">interactive</span> (list (read-string <span style="color: #4F894C;">"tag (include the #): "</span>)))
 (<span style="color: #3B6EA8;">dolist</span> (zdFile (zd-get-file-list zdSrch))
  (zd-org-include-file zdFile)
))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgca284ee" class="outline-4">
<h4 id="orgca284ee"><span class="section-number-4">4.4.3</span> <code>zd-org-include-file</code> includes a file in <code>org</code> format</h4>
<div class="outline-text-4" id="text-4-4-3">
<p>
Inserts the title as a new header, with the <code>#+INCLUDE</code> line below.
Includes only from the second line onward, so that any <code>#+TITLE</code> lines are omitted.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #3B6EA8;">defun</span> <span style="color: #29838D;">zd-org-include-file</span> (zdFile)
<span style="color: #828b9b;">"Insert code to include org-file zdFile."</span>
 (insert
   <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">Insert org-mode title</span>
   <span style="color: #4F894C;">"\n* "</span> (zd-lift-file-title zdFile) <span style="color: #4F894C;">"\n"</span>
   <span style="color: #8b94a5;">;; </span><span style="color: #8b94a5;">Insert #+INCLUDE: "file.org" :lines 2-</span>
   <span style="color: #4F894C;">"#+INCLUDE: \""</span> zdFile <span style="color: #4F894C;">"\" :lines \"2-\"\n"</span>
 ))
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org1973f22" class="outline-2">
<h2 id="org1973f22"><span class="section-number-2">5</span> Aesthetics</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org10e55c1" class="outline-3">
<h3 id="org10e55c1"><span class="section-number-3">5.1</span> Highlighting zetteldeft links</h3>
<div class="outline-text-3" id="text-5-1">
<p>
To highlight zetteldeft links, let's add a <code>font-lock</code> keyword to <code>org-mode</code>.
</p>

<p>
Currently, the regexp to find links is hardcoded.
</p>

<p>
Highlighting not working in comments.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(font-lock-add-keywords 'org-mode '(
  (<span style="color: #4F894C;">"&#167;[0-9]\\{2,\\}-[0-9-]+"</span> . font-lock-warning-face)
  ))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7411560" class="outline-2">
<h2 id="org7411560"><span class="section-number-2">6</span> Brainstorm</h2>
<div class="outline-text-2" id="text-6">
<p>
Some ideas for the future.
</p>
</div>

<div id="outline-container-orge6b5be5" class="outline-3">
<h3 id="orge6b5be5"><span class="section-number-3">6.1</span> Saved searches</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Create a list of saved searches, somewhere easily accessible.
</p>
</div>
</div>

<div id="outline-container-org6b6c635" class="outline-3">
<h3 id="org6b6c635"><span class="section-number-3">6.2</span> Generate list of tags</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Auto-generate a list of tags.
</p>

<p>
Might exceed my elisp-fu.
</p>
</div>
</div>

<div id="outline-container-orgd0b5cbf" class="outline-3">
<h3 id="orgd0b5cbf"><span class="section-number-3">6.3</span> HTML export</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Export HTML pages with clickeable links between notes.
</p>
</div>
</div>

<div id="outline-container-org6d3f49c" class="outline-3">
<h3 id="org6d3f49c"><span class="section-number-3">6.4</span> Markdown export</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Export markdown through <code>pandoc</code>.
</p>
</div>
</div>

<div id="outline-container-org0019ab4" class="outline-3">
<h3 id="org0019ab4"><span class="section-number-3">6.5</span> Templates</h3>
<div class="outline-text-3" id="text-6-5">
<p>
A system for note templates.
</p>
</div>
</div>

<div id="outline-container-orga2821ce" class="outline-3">
<h3 id="orga2821ce"><span class="section-number-3">6.6</span> Minor mode</h3>
<div class="outline-text-3" id="text-6-6">
<p>
Create a minor mode on top of org-mode with some niceties:
</p>
<ul class="org-ul">
<li>higlight links &amp; tags</li>
<li>clickeable links</li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
For those not yet familiar: <b>deft</b> is a note manager within <code>emacs</code>, for easily searching and retreiving plain text notes.
It is inspired by the popular Notational Velocity.
Check out <a href="https://jblevins.org/projects/deft/">jblevins.org/projects/deft/</a> and <a href="http://notational.net">notational.net</a>.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">

<hr>
<p class='author'>Author: EFLS</p>
<p class="date">Date: 2018-08-25 Sat 22:19</p>
<p class="creator">Made with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.1 (<a href="https://orgmode.org">Org</a> mode 9.1.13)</p>
</div>
</body>
</html>
